# 架构设计文档

## 概述

本组件采用基于 Vue 3 的组件化架构，使用 Pinia 进行状态管理，通过组合式函数（Composables）实现复杂逻辑的复用。

## 核心架构

### 1. 组件层级

```
VideoTrack (主容器)
├── ToolsBar (工具栏)
│   ├── 操作按钮区
│   ├── 播放控制区
│   └── 缩放控制区
├── Ruler (时间线)
│   ├── 刻度渲染
│   └── 播放游标
└── Tracks (轨道组)
    ├── Track (单个轨道)
    │   ├── TrackControl (轨道操作栏)
    │   └── TrackArea (轨道区域)
    │       └── ClipItem (片段)
    │           └── [不同类型的 Clip 组件]
    └── ContextMenu (右键菜单)
```

### 2. 状态管理

使用 Pinia 管理全局状态，分为以下几个 store：

#### TracksStore

- 管理所有轨道和片段数据
- 提供轨道和片段的增删改查方法
- 管理选中状态

#### PlaybackStore

- 管理播放状态（播放/暂停）
- 管理当前播放时间
- 管理播放速率

#### HistoryStore

- 管理操作历史记录
- 提供撤销/重做功能
- 支持快照序列化

#### ScaleStore

- 管理缩放比例
- 管理吸附功能
- 提供时间和像素的转换方法

#### DragStore

- 处理 Clip 拖拽逻辑
- 管理拖拽状态（isDragging、dragOffset、previewPosition）
- 支持同轨/跨轨移动
- 实现吸附功能
- 处理碰撞检测和位置调整

### 3. 组合式函数（Composables）

#### useResize

- 处理 Clip 时长调整
- 限制最小时长和原始时长
- 支持吸附

#### useSelection

- 处理框选功能
- 支持多选（Ctrl/Shift）
- 管理选中状态

#### useKeyboard

- 处理快捷键
- 支持跨平台（Windows/Mac）
- 提供完整的快捷键映射

#### useVirtualScroll

- 实现虚拟滚动
- 优化大量轨道/片段的渲染性能

## 数据流

```
用户操作
    ↓
组件事件处理
    ↓
Composable 处理逻辑
    ↓
Store 状态更新
    ↓
组件响应式更新
    ↓
UI 重新渲染
```

## 核心算法

### 1. 时间-像素转换

```typescript
// 时间转像素
pixelPosition = time × scale × pixelsPerSecond

// 像素转时间
time = pixelPosition / (scale × pixelsPerSecond)
```

### 2. 吸附算法

计算当前位置与所有吸附点的距离，如果最小距离小于阈值，则吸附到该点。

### 3. 主轨道连续排列

- 插入：计算插入位置，后方所有 Clip 向后移动
- 移除：后方所有 Clip 向前移动填充空隙
- 确保从 0 开始，无间隙连续排列

### 4. 碰撞检测

使用时间区间重叠算法：

```
overlap = (start1 < end2) && (end1 > start2)
```

## 性能优化策略

### 1. 虚拟滚动

只渲染可视区域内的轨道和片段，减少 DOM 节点数量。

### 2. 懒加载

使用 IntersectionObserver 实现图片和波形图的懒加载。

### 3. 节流渲染

使用 requestAnimationFrame 节流拖拽等高频操作的渲染。

### 4. 缓存管理

使用 LRU 缓存管理缩略图和波形图数据。

### 5. 批量更新

将多个 DOM 更新合并到一次 requestAnimationFrame 中执行。

## 扩展机制

### 1. 自定义按钮

通过 slot 插槽扩展工具栏按钮。

### 2. 自定义菜单项

通过配置项和 slot 扩展右键菜单。

### 3. 自定义轨道类型

通过配置项定义新的轨道类型，并提供对应的渲染组件。

### 4. 事件回调

暴露完整的事件系统，方便业务层集成。

## 测试策略

### 1. 单元测试

- Store 的状态管理逻辑
- Composable 的纯函数逻辑
- 工具函数

### 2. 组件测试

- 组件的渲染
- 组件的交互
- 组件的事件触发

### 3. 集成测试

- 完整的用户操作流程
- 跨组件的数据流
- 性能测试

## 未来规划

1. 支持更多轨道类型（形状、文字动画等）
2. 支持关键帧动画编辑
3. 支持轨道分组
4. 支持轨道效果（淡入淡出、变速等）
5. 支持实时预览
6. 支持导出时间线数据
7. 支持撤销树（而非线性历史）
8. 支持协作编辑
